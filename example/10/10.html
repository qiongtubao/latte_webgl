<html>
<header>

</header>

<body>
  <canvas id="canvas" width="680" height="1000"></canvas>
</body>
<script src="../latte_lib.js"></script>
<script src="../latte_webgl.js"></script>
<script>
  //彩色三角形
  var latte_lib = latte.require("latte_lib");
  var LatteWebGL = latte.require("latte_webgl");
  var drawWebGL = LatteWebGL.createDrawWebGL(document.getElementById("canvas"));
  // drawWebGL.createParam('webgl', '','');


  let compileShader = function (gl, type, shaderStr) {
    var shader = gl.createShader(type);
    if (shader == null) {
      console.error("can't to create shader");
      return null;
    }
    gl.shaderSource(shader, shaderStr);
    gl.compileShader(shader);
    var shaderParameter = gl.getShaderParameter(shader, gl.COMPILE_STATUS);
    if (!shaderParameter) {
      var log = gl.getShaderInfoLog(shader);
      console.error("error log:", log);
      gl.deleteShader(shader);
      return null;
    }
    return shader;
  }
  function createArrayBuffer(gl, buffer, size) {
    if (buffer == null) {
      buffer = gl.createBuffer();
    }
    gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
    gl.bufferData(gl.ARRAY_BUFFER, size, gl.DYNAMIC_DRAW);
    return buffer;
  }
  function createElementArrayBuffer(gl, buffer, size) {
    if (buffer == null) {
      buffer = gl.createBuffer();
    }
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, buffer);
    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, size, gl.DYNAMIC_DRAW);
    return buffer;
  }
  latte_lib.async.auto({
    "vsh": function (cb) {
      drawWebGL.loadFile('./10.vsh', cb);
    },
    "fsh": function (cb) {
      drawWebGL.loadFile('./10.fsh', cb);
    },
    "texture": function (cb) {
      drawWebGL.loadImage('./texture_00.png', cb);
    }
  }, function (err, data) {
    let gl = drawWebGL.gl;
    var param = drawWebGL.createParam('10', data.vsh, data.fsh);
    drawWebGL.useProgram("10");
    let mtexture = param.createTexture("texture");
    let s_texture0_Loc = gl.getUniformLocation(param.shaderProgram, "s_texture0");
    let s_texture0 = param.getUniformLocation('s_texture0', 'vec1');
    mtexture.set2(s_texture0, data.texture.source);
    let texture = mtexture.texture;
    let a_position = param.getAttribLocation("a_position", "vec2");
    let a_texCoord = param.getAttribLocation("a_texCoord", "vec2");
    let u_mvpMatrix = param.getUniformLocation("u_mvpMatrix", "matrix4");
    let u_baseColor = param.getUniformLocation("u_baseColor", "vec4");
    let u_maskFlag = param.getUniformLocation("u_maskFlag", "vec1");
    let u_channelFlag = param.getUniformLocation("u_channelFlag", "vec4");
    let anisotropyExt = param.getExtension("EXT_texture_filter_anisotropic");
    setInterval(function () {
      drawWebGL.clean();
      //let bufferData1 = [1297.85205078125, 2239.259521484375, 1635.2188720703125, 2279.743408203125, 2056.927001953125, 2330.3486328125, 2387.546142578125, 2367.458984375, 2411.163330078125, 2900.49853515625, 2384.17578125, 3339.07568359375, 2370.681640625, 3598.848388671875, 2255.978515625, 3754.03369140625, 2063.680908203125, 3750.653564453125, 1732.822998046875, 3728.179443359375, 1452.5687255859375, 3634.71728515625, 1202.292724609375, 3575.620361328125, 1195.661376953125, 3079.824951171875, 1240.503173828125, 2522.637451171875, 1604.8568115234375, 2549.636962890625, 2097.41162109375, 2640.72509765625, 2073.799560546875, 3028.687744140625, 2110.9111328125, 3474.013671875, 1830.8975830078125, 3393.044921875, 1532.28076171875, 3434.5712890625, 1594.7412109375, 2924.097412109375];
      let bufferData1 = [445.2587890625, 405.4639587402344, 487.268798828125, 406.8366394042969, 531.26806640625, 419.79510498046875, 575.206298828125, 448.3003234863281, 591.4033203125, 490.10272216796875, 587.4528198242188, 534.0684204101562, 563.7157592773438, 577.908447265625, 520.5921630859375, 616.0585327148438, 477.6554260253906, 621.277099609375, 438.3773193359375, 619.0218505859375, 391.759033203125, 586.6201171875, 361.96990966796875, 542.4696655273438, 355.06976318359375, 500.38348388671875, 363.96185302734375, 456.7742614746094, 401.49456787109375, 412.6288757324219, 455.6595153808594, 427.5171813964844, 495.75439453125, 435.2069091796875, 535.4479370117188, 457.093994140625, 557.9924926757812, 484.07244873046875, 558.6193237304688, 512.1513061523438, 548.9225463867188, 551.1796875, 525.7634887695312, 577.4437866210938, 499.73809814453125, 592.2029418945312, 457.3386535644531, 593.3607788085938, 429.24078369140625, 582.244140625, 395.9095153808594, 549.2936401367188, 387.1858215332031, 521.378662109375, 388.4210205078125, 478.30682373046875, 402.4703369140625, 451.15496826171875, 423.8862609863281, 426.22003173828125, 448.7528381347656, 450.3377685546875, 423.1256103515625, 487.54522705078125, 473.2083740234375, 487.48883056640625, 522.047607421875, 481.70172119140625, 438.4214782714844, 537.4948120117188, 503.2510070800781, 541.6189575195312];
      let startx = 1297.85205078125;
      let starty = 2239.259521484375;
      // let bufferData1 = ([445.2587890625, 405.4639587402344, 487.268798828125, 406.8366394042969, 531.26806640625, 419.79510498046875, 575.206298828125, 448.3003234863281, 591.4033203125, 490.10272216796875, 587.4528198242188, 534.0684204101562, 563.7157592773438, 577.908447265625, 520.5921630859375, 616.0585327148438, 477.6554260253906, 621.277099609375, 438.3773193359375, 619.0218505859375, 391.759033203125, 586.6201171875, 361.96990966796875, 542.4696655273438, 355.06976318359375, 500.38348388671875, 363.96185302734375, 456.7742614746094, 401.49456787109375, 412.6288757324219, 455.6595153808594, 427.5171813964844, 495.75439453125, 435.2069091796875, 535.4479370117188, 457.093994140625, 557.9924926757812, 484.07244873046875, 558.6193237304688, 512.1513061523438, 548.9225463867188, 551.1796875, 525.7634887695312, 577.4437866210938, 499.73809814453125, 592.2029418945312, 457.3386535644531, 593.3607788085938, 429.24078369140625, 582.244140625, 395.9095153808594, 549.2936401367188, 387.1858215332031, 521.378662109375, 388.4210205078125, 478.30682373046875, 402.4703369140625, 451.15496826171875, 423.8862609863281, 426.22003173828125, 448.7528381347656, 450.3377685546875, 423.1256103515625, 487.54522705078125, 473.2083740234375, 487.48883056640625, 522.047607421875, 481.70172119140625, 438.4214782714844, 537.4948120117188, 503.2510070800781, 541.6189575195312]).map(function (o, index) {
      //   if (index % 2 == 0) {
      //     return (o - startx) / 2;
      //   } else {
      //     return (o - starty) / 2;
      //   }
      // });
      let elements = [0, 1, 15, 1, 16, 15, 1, 2, 16, 2, 17, 16, 2, 3, 17, 3, 18, 17, 3, 4, 18, 4, 19, 18, 4, 5, 19, 5, 20, 19, 5, 6, 20, 6, 21, 20, 6, 7, 21, 7, 22, 21, 7, 8, 22, 8, 23, 22, 8, 9, 23, 9, 24, 23, 9, 10, 24, 10, 25, 24, 10, 11, 25, 11, 12, 26, 11, 26, 25, 12, 27, 26, 12, 13, 27, 13, 28, 27, 13, 14, 28, 29, 28, 14, 0, 29, 14, 0, 15, 29, 30, 15, 16, 29, 30, 28, 29, 15, 30, 27, 31, 26, 28, 31, 27, 28, 30, 31, 32, 31, 30, 16, 32, 30, 33, 18, 19, 17, 18, 33, 16, 17, 33, 16, 33, 32, 34, 31, 32, 25, 34, 24, 26, 34, 25, 26, 31, 34, 23, 24, 34, 35, 34, 32, 20, 21, 35, 33, 35, 32, 19, 35, 33, 19, 20, 35, 22, 35, 21, 23, 35, 22, 23, 34, 35];
      let bufferData2 = [
        0.37841796875, 0.65625, 0.39892578125, 0.6552734375, 0.42041015625, 0.646484375, 0.44189453125, 0.626953125, 0.44970703125, 0.6064453125, 0.44775390625, 0.5849609375, 0.43603515625, 0.5634765625, 0.41455078125, 0.544921875, 0.3932090699672699, 0.5424900054931641, 0.3737795948982239, 0.5436504483222961, 0.35107421875, 0.5595703125, 0.33642578125, 0.5810546875, 0.33349609375, 0.6015625, 0.33837890625, 0.623046875, 0.35693359375, 0.64453125, 0.388671875, 0.64111328125, 0.40697890520095825, 0.637550950050354, 0.42312586307525635, 0.6271067261695862, 0.4322964549064636, 0.6139370799064636, 0.43408203125, 0.595703125, 0.42873549461364746, 0.5766355991363525, 0.41726648807525635, 0.5638112425804138, 0.404296875, 0.556640625, 0.38330078125, 0.55615234375, 0.3695545196533203, 0.5616501569747925, 0.35322844982147217, 0.5776768922805786, 0.34912109375, 0.59130859375, 0.35009765625, 0.6123046875, 0.3572682738304138, 0.6257625818252563, 0.36767578125, 0.63671875, 0.379891037940979, 0.6261189579963684, 0.367061972618103, 0.6077781915664673, 0.3916893005371094, 0.6077898740768433, 0.41572457551956177, 0.6105706691741943, 0.3743044435977936, 0.5833845734596252, 0.40617501735687256, 0.5813360214233398
      ];
      // let matrix4x4 = [
      //   0.0015625000232830644, 0, 0, 0,
      //   0, -0.0011303190840408206, 0, 0,
      //   0, 0, 1, 0,
      //   -1, 0.7234042286872864, 0, 1
      // ];
      let matrix4x4 = [
        0.009589802473783493, 0, 0, 0, 0, 0.009211819618940353, 0, 0, 0, 0, 1, 0, -4.5432257652282715, -4.655473232269287, 0, 1
      ];
      let arrayBuffer = param.getArrayBuffer("arrayBuffer").set(bufferData1);
      param.getElementArrayBuffer("elements").set(elements);
      param.bindBuffer("arrayBuffer", "a_position", 0);
      let arrayBuffer2 = param.getArrayBuffer("arrayBuffer2").set(bufferData2);
      param.bindTexture("texture", 1);
      s_texture0.set(1);
      param.bindBuffer("arrayBuffer2", "a_texCoord", 0);
      u_mvpMatrix.set(matrix4x4);
      u_channelFlag.set([0, 0, 0, 1]);
      u_baseColor.set([-1, -1, 1, 1]);
      u_maskFlag.set(1);
      gl.enable(gl.CULL_FACE);
      gl.enable(gl.BLEND);
      gl.blendEquationSeparate(gl.FUNC_ADD, gl.FUNC_ADD);
      gl.blendFuncSeparate(gl.ONE, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE_MINUS_SRC_ALPHA);
      if (anisotropyExt.isOK()) {
        gl.texParameteri(gl.TEXTURE_2D, anisotropyExt.ext.TEXTURE_MAX_ANISOTROPY_EXT, anisotropyExt.getParameter("MAX_TEXTURE_MAX_ANISOTROPY_EXT"));
      }
      gl.drawElements(gl.TRIANGLES, elements.length, gl.UNSIGNED_SHORT, 0);
      gl.bindTexture(gl.TEXTURE_2D, null);

    }, 100);

  });
</script>

</html>